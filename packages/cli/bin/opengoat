#!/usr/bin/env node
import { spawn } from "node:child_process";
import { existsSync } from "node:fs";
import { dirname, resolve } from "node:path";
import { fileURLToPath, pathToFileURL } from "node:url";

const binDir = dirname(fileURLToPath(import.meta.url));
const projectRoot = resolve(binDir, "..");
const distEntrypoint = resolve(projectRoot, "dist/index.js");
const srcEntrypoint = resolve(projectRoot, "src/index.ts");

const hasDist = existsSync(distEntrypoint);
const hasSrc = existsSync(srcEntrypoint);
const envForcesSrc = process.env.OPENGOAT_USE_SRC === "1";
const envForcesDist = process.env.OPENGOAT_USE_DIST === "1";

const preferSrc = envForcesSrc || (hasSrc && !envForcesDist);

if (hasDist && !preferSrc) {
  await import(pathToFileURL(distEntrypoint).href);
} else if (hasSrc) {
  const child = spawn(process.execPath, ["--import", "tsx", srcEntrypoint, ...process.argv.slice(2)], {
    stdio: "inherit",
    env: process.env,
    cwd: projectRoot
  });

  child.on("exit", (code, signal) => {
    if (signal) {
      process.kill(process.pid, signal);
      return;
    }

    process.exit(code ?? 1);
  });
} else {
  throw new Error(`Missing CLI entrypoints. dist=${distEntrypoint} src=${srcEntrypoint}`);
}
